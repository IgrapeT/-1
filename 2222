#include <iostream>
#include <string>
#include <vector>
#include <iomanip>
#include <limits>
#include <algorithm>
#include <cctype>
#include <windows.h>
 
using namespace std;
 
// Перечисление для типа звонка
enum class CallType {
   LOCAL,
   LONG_DISTANCE,
   INTERNATIONAL
};
 
// Класс Тариф
class Tariff {
private:
   string city;
   double costPerMinute;
   CallType type;
 
public:
   Tariff(const string& cityName, double cost, CallType callType = CallType::LONG_DISTANCE)
       : city(cityName), costPerMinute(cost), type(callType) {}
 
   string getCity() const { return city; }
   double getCost() const { return costPerMinute; }
   CallType getType() const { return type; }
};
 
// Класс Звонок
class Call {
private:
   string city;
   int duration; // в минутах
   Tariff* tariff;
 
public:
   Call(const string& cityName, int callDuration, Tariff* callTariff)
       : city(cityName), duration(callDuration), tariff(callTariff) {}
 
   double calculateCost() const {
       return duration * tariff->getCost();
   }
 
   string getCity() const { return city; }
   int getDuration() const { return duration; }
   Tariff* getTariff() const { return tariff; }
 
   void displayInfo() const {
       cout << "Город: " << city << ", Длительность: " << duration
            << " мин, Стоимость: " << fixed << setprecision(2) << calculateCost() << " руб." << endl;
   }
};
 
// Класс Клиент
class Client {
private:
   string lastName;
   string firstName;
   string phoneNumber;
   vector<Call> calls;
 
public:
   Client(const string& last, const string& first, const string& phone)
       : lastName(last), firstName(first), phoneNumber(phone) {}
 
   string getLastName() const { return lastName; }
   string getFirstName() const { return firstName; }
   string getFullName() const { return lastName + " " + firstName; }
   string getPhone() const { return phoneNumber; }
 
   void addCall(const Call& call) {
       calls.push_back(call);
   }
 
   double calculateTotalCost() const {
       double total = 0.0;
       for (const auto& call : calls) {
           total += call.calculateCost();
       }
       return total;
   }
 
   vector<Call> getCalls() const { return calls; }
 
   void displayInfo() const {
       cout << "Клиент: " << getFullName() << " (" << phoneNumber << ")" << endl;
       cout << "Всего звонков: " << calls.size() << endl;
       cout << "Общая стоимость: " << fixed << setprecision(2) << calculateTotalCost() << " руб." << endl;
   }
};
 
// Класс АТС (Singleton)
class ATC {
private:
   static ATC* instance;
   vector<Tariff> tariffs;
   vector<Client> clients;
 
   // Приватный конструктор
   ATC() {
       // Добавляем несколько тарифов по умолчанию с дробными стоимостями
       tariffs.push_back(Tariff("Москва", 5.5));
       tariffs.push_back(Tariff("Санкт-Петербург", 4.75));
       tariffs.push_back(Tariff("Новосибирск", 6.25));
       tariffs.push_back(Tariff("Екатеринбург", 5.8));
   }
 
public:
   // Удаление копирования и присваивания
   ATC(const ATC&) = delete;
   ATC& operator=(const ATC&) = delete;
 
   // Получение экземпляра
   static ATC* getInstance() {
       if (instance == nullptr) {
           instance = new ATC();
       }
       return instance;
   }
 
   // Деструктор
   ~ATC() {
       // Очищаем векторы
       tariffs.clear();
       clients.clear();
   }
 
   // Методы работы с тарифами
   void addTariff(const string& city, double cost) {
       tariffs.push_back(Tariff(city, cost));
       cout << "Тариф для города " << city << " добавлен." << endl;
   }
 
   Tariff* findTariff(const string& city) {
       for (auto& tariff : tariffs) {
           if (tariff.getCity() == city) {
               return &tariff;
           }
       }
       return nullptr;
   }
 
   void showTariffs() const {
       cout << "\n=== Список тарифов ===" << endl;
       if (tariffs.empty()) {
           cout << "Тарифы не найдены." << endl;
           return;
       }
       for (const auto& tariff : tariffs) {
           cout << "Город: " << tariff.getCity()
                << ", Стоимость: " << fixed << setprecision(2) << tariff.getCost() << " руб/мин" << endl;
       }
   }
 
   // Методы работы с клиентами
   void addClient(const string& lastName, const string& firstName, const string& phone) {
       // Проверяем, нет ли уже клиента с таким номером телефона
       if (findClientByPhone(phone) != nullptr) {
           cout << "Ошибка: клиент с номером телефона " << phone << " уже существует." << endl;
           return;
       }
       clients.push_back(Client(lastName, firstName, phone));
       cout << "Клиент " << lastName << " " << firstName << " добавлен." << endl;
   }
 
   // Поиск клиента по номеру телефона (основной метод)
   Client* findClientByPhone(const string& phone) {
       for (auto& client : clients) {
           if (client.getPhone() == phone) {
               return &client;
           }
       }
       return nullptr;
   }
 
   void addCallToClient(const string& phone, const string& city, int duration) {
       Client* client = findClientByPhone(phone);
       if (!client) {
           cout << "Ошибка: клиент с номером телефона '" << phone << "' не найден." << endl;
           return;
       }
 
       Tariff* tariff = findTariff(city);
       if (!tariff) {
           cout << "Ошибка: тариф для города '" << city << "' не найден." << endl;
           return;
       }
 
       client->addCall(Call(city, duration, tariff));
       cout << "Звонок в город " << city << " длительностью " << duration
            << " мин добавлен клиенту " << client->getFullName() << endl;
   }
 
   void showClientCalls(const string& phone) {
       Client* client = findClientByPhone(phone);
       if (!client) {
           cout << "Ошибка: клиент с номером телефона '" << phone << "' не найден." << endl;
           return;
       }
 
       cout << "\n=== Звонки клиента " << client->getFullName() << " ===" << endl;
       client->displayInfo();
       
       vector<Call> calls = client->getCalls();
       if (calls.empty()) {
           cout << "Звонков не найдено." << endl;
       } else {
           cout << "Детали звонков:" << endl;
           for (const auto& call : calls) {
               call.displayInfo();
           }
       }
   }
 
   void showTotalRevenue() {
       double total = 0.0;
       for (const auto& client : clients) {
           total += client.calculateTotalCost();
       }
       cout << "\n=== Общая выручка АТС ===" << endl;
       cout << "Общая стоимость всех звонков: " << fixed << setprecision(2) << total << " руб." << endl;
       cout << "Всего клиентов: " << clients.size() << endl;
   }
 
   void showClients() const {
       cout << "\n=== Список клиентов ===" << endl;
       if (clients.empty()) {
           cout << "Клиенты не найдены." << endl;
           return;
       }
       for (const auto& client : clients) {
           client.displayInfo();
           cout << "---" << endl;
       }
   }
 
   // Поиск клиента по номеру телефона с выводом информации
   void findAndDisplayClient(const string& phone) {
       Client* client = findClientByPhone(phone);
       if (!client) {
           cout << "Клиент с номером телефона '" << phone << "' не найден." << endl;
           return;
       }
       
       cout << "\n=== Информация о клиенте ===" << endl;
       client->displayInfo();
   }
};
 
// Инициализация статического члена
ATC* ATC::instance = nullptr;
 
// Функция для проверки номера телефона
bool isValidPhoneNumber(const string& phone) {
   if (phone.empty() || phone.length() < 5) return false;
   
   // Проверяем, что номер содержит только цифры, +, -, пробелы и скобки
   for (char c : phone) {
       if (!isdigit(c) && c != '+' && c != '-' && c != ' ' && c != '(' && c != ')') {
           return false;
       }
   }
   return true;
}
 
// Функция для проверки, является ли строка числом (целым или дробным)
bool isNumber(const string& str) {
   if (str.empty()) return false;
   
   bool hasDecimal = false;
   bool hasDigit = false;
   
   for (size_t i = 0; i < str.length(); i++) {
       char c = str[i];
       
       // Разрешаем знак минуса только в начале
       if (i == 0 && c == '-') {
           continue;
       }
       
       // Разрешаем десятичную точку или запятую
       if (c == '.' || c == ',') {
           if (hasDecimal) return false; // Уже была точка
           hasDecimal = true;
           continue;
       }
       
       if (isdigit(c)) {
           hasDigit = true;
       } else {
           return false; // Не цифра и не разрешенный символ
       }
   }
   
   return hasDigit; // Должна быть хотя бы одна цифра
}
 
// Функции для ввода с проверкой
int inputInt(const string& prompt) {
   int value;
   while (true) {
       cout << prompt;
       string input;
       getline(cin, input);
       
       if (input.empty()) {
           cout << "Ошибка! Введите целое число: ";
           continue;
       }
       
       try {
           size_t pos;
           value = stoi(input, &pos);
           
           if (pos != input.length()) {
               cout << "Ошибка! Введите целое число: ";
               continue;
           }
           
           if (value <= 0) {
               cout << "Ошибка! Число должно быть положительным: ";
               continue;
           }
           
           if (value > 10080) { // Максимум неделя в минутах
               cout << "Ошибка! Длительность не может превышать 10080 минут: ";
               continue;
           }
           
           break;
       }
       catch (const exception& e) {
           cout << "Ошибка! Введите целое число: ";
       }
   }
   return value;
}
 
double inputDouble(const string& prompt) {
   double value;
   while (true) {
       cout << prompt;
       string input;
       getline(cin, input);
       
       if (input.empty()) {
           cout << "Ошибка! Введите число: ";
           continue;
       }
       
       // Заменяем запятые на точки для корректного преобразования
       for (char& c : input) {
           if (c == ',') c = '.';
       }
       
       // Проверяем, что введено число
       if (!isNumber(input)) {
           cout << "Ошибка! Введите число: ";
           continue;
       }
       
       try {
           size_t pos;
           value = stod(input, &pos);
           
           if (pos != input.length()) {
               cout << "Ошибка! Введите число: ";
               continue;
           }
           
           if (value <= 0) {
               cout << "Ошибка! Число должно быть положительным: ";
               continue;
           }
           
           if (value > 1000.0) {
               cout << "Ошибка! Стоимость не может превышать 1000 руб/мин: ";
               continue;
           }
           
           break;
       }
       catch (const exception& e) {
           cout << "Ошибка! Введите число: ";
       }
   }
   return value;
}
 
string inputString(const string& prompt) {
   string value;
   while (true) {
       cout << prompt;
       getline(cin, value);
       
       // Удаляем пробелы в начале и конце
       size_t start = value.find_first_not_of(" \t\n\r");
       size_t end = value.find_last_not_of(" \t\n\r");
       
       if (start == string::npos) {
           cout << "Ошибка! Строка не может быть пустой: ";
           continue;
       }
       
       value = value.substr(start, end - start + 1);
       
       if (value.empty()) {
           cout << "Ошибка! Строка не может быть пустой: ";
           continue;
       }
       
       break;
   }
   return value;
}
 
string inputName(const string& prompt) {
   string value;
   while (true) {
       value = inputString(prompt);
       
       if (value.length() < 2) {
           cout << "Ошибка! Имя/фамилия должны быть не короче 2 символов: ";
           continue;
       }
       
       break;
   }
   return value;
}
 
string inputCity(const string& prompt) {
   string value;
   while (true) {
       value = inputString(prompt);
       
       if (value.length() < 2) {
           cout << "Ошибка! Название города должно быть не короче 2 символов: ";
           continue;
       }
       
       break;
   }
   return value;
}
 
string inputPhone(const string& prompt) {
   string value;
   while (true) {
       value = inputString(prompt);
       
       if (!isValidPhoneNumber(value)) {
           cout << "Ошибка! Введите корректный номер телефона: ";
           continue;
       }
       
       break;
   }
   return value;
}
 
int inputMenuChoice() {
   int choice;
   while (true) {
       cout << "Выберите действие: ";
       string input;
       getline(cin, input);
       
       if (input.empty()) {
           cout << "Ошибка! Введите число от 0 до 8: ";
           continue;
       }
       
       try {
           size_t pos;
           choice = stoi(input, &pos);
           
           if (pos != input.length()) {
               cout << "Ошибка! Введите число от 0 до 8: ";
               continue;
           }
           
           if (choice < 0 || choice > 8) {
               cout << "Ошибка! Введите число от 0 до 8: ";
               continue;
           }
           
           break;
       }
       catch (const exception& e) {
           cout << "Ошибка! Введите число от 0 до 8: ";
       }
   }
   return choice;
}
 
// Функция для настройки консоли
void setupConsole() {
   // Устанавливаем кодировку UTF-8
   SetConsoleOutputCP(65001);
   SetConsoleCP(65001);
   
   // Настраиваем локаль
   setlocale(LC_ALL, "Russian");
}
 
// Функция меню
void showMainMenu() {
   ATC* atc = ATC::getInstance();
 
   while (true) {
       cout << "\n=== СИСТЕМА УПРАВЛЕНИЯ АТС ===" << endl;
       cout << "1. Показать тарифы" << endl;
       cout << "2. Добавить тариф" << endl;
       cout << "3. Показать всех клиентов" << endl;
       cout << "4. Добавить клиента" << endl;
       cout << "5. Найти клиента по номеру телефона" << endl;
       cout << "6. Добавить звонок клиенту" << endl;
       cout << "7. Показать звонки клиента" << endl;
       cout << "8. Показать общую выручку" << endl;
       cout << "0. Выход" << endl;
       
       int choice = inputMenuChoice();
 
       switch (choice) {
           case 1:
               atc->showTariffs();
               break;
           case 2: {
               string city = inputCity("Введите город: ");
               double cost = inputDouble("Введите стоимость за минуту (руб.): ");
               atc->addTariff(city, cost);
               break;
           }
           case 3:
               atc->showClients();
               break;
           case 4: {
               string lastName = inputName("Введите фамилию: ");
               string firstName = inputName("Введите имя: ");
               string phone = inputPhone("Введите номер телефона: ");
               atc->addClient(lastName, firstName, phone);
               break;
           }
           case 5: {
               string phone = inputPhone("Введите номер телефона для поиска: ");
               atc->findAndDisplayClient(phone);
               break;
           }
           case 6: {
               string phone = inputPhone("Введите номер телефона клиента: ");
               string city = inputCity("Введите город: ");
               int duration = inputInt("Введите длительность звонка (мин): ");
               atc->addCallToClient(phone, city, duration);
               break;
           }
           case 7: {
               string phone = inputPhone("Введите номер телефона клиента: ");
               atc->showClientCalls(phone);
               break;
           }
           case 8:
               atc->showTotalRevenue();
               break;
           case 0:
               cout << "Выход из программы." << endl;
               return;
       }
   }
}
 
int main() {
   // Настройка консоли
   setupConsole();
   
   cout << "=== СИСТЕМА УПРАВЛЕНИЯ АВТОМАТИЧЕСКОЙ ТЕЛЕФОННОЙ СТАНЦИЕЙ ===" << endl;
   cout << "Система готова к работе!" << endl;
   
   showMainMenu();
   
   return 0;
}
